<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | CovidSafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Admin Specific Styles */
        body { overflow-y: auto; }
        .content { padding: 40px 5%; max-width: 1200px; margin: 0 auto; }
        
        /* Tabs */
        .admin-tabs { display: flex; gap: 20px; margin-bottom: 20px; }
        .tab-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #aaa; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600;
            transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary-glow); color: white; border-color: var(--primary-glow); }
        .hidden { display: none; }

        /* Tables */
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th { text-align: left; color: var(--text-muted); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: white; }
        .admin-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges */
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        .badge-pass { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-fail { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Question List Item */
        .q-item {
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .action-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .btn-del { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .btn-edit { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    </style>
</head>
<body>
    <div class="aurora-bg"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <!-- Header -->
    <header style="position: sticky; top: 0; z-index: 50; padding: 20px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(3, 3, 5, 0.9); border-bottom: 1px solid rgba(255,255,255,0.08);">
        <div style="font-size: 22px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px;">
            <i class="ri-admin-line" style="color: var(--primary-glow);"></i> Admin Portal
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="adminEmail" style="color: #aaa; font-size: 0.9rem;"></span>
            <button onclick="handleLogout()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Logout</button>
        </div>
    </header>

    <div class="content">
        <!-- ADMIN CONTAINER -->
        <div id="adminContainer">
            
            <!-- Tabs Navigation -->
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('questions')">Manage Questions</button>
                <button class="tab-btn" onclick="switchTab('reports')">View Reports</button>
            </div>

            <!-- TAB 1: MANAGE QUESTIONS -->
            <div id="tab-questions">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    
                    <!-- Left: Add/Edit Form -->
                    <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; height: fit-content;">
                        <h3 style="color: white; margin-bottom: 20px;" id="formTitle">Add New Question</h3>
                        
                        <!-- Hidden ID for Editing -->
                        <input type="hidden" id="editQId" value="">

                        <input type="text" id="qText" placeholder="Enter Question Text here...">
                        
                        <select id="qType" style="background: #222; color: white; margin-bottom: 20px;">
                            <option value="single">Single Choice (Yes/No)</option>
                            <option value="multiple">Multiple Choice</option>
                            <option value="data">Info / Text Only</option>
                        </select>

                        <div id="optionsArea" style="width: 100%; margin-bottom: 15px;">
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">Answer Options (and Fail Triggers):</p>
                            <div id="optionsList"></div>
                            <button onclick="addOptionInput()" style="background: none; border: 1px dashed #555; color: #aaa; padding: 8px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 5px;">+ Add Option</button>
                        </div>
                        
                        <div style="display:flex; gap:10px; width:100%;">
                            <button onclick="saveQuestion()" id="saveBtn" class="glow-button">Save Question</button>
                            <button onclick="resetForm()" id="cancelBtn" class="glow-button" style="background:transparent; border:1px solid #555; display:none;">Cancel</button>
                        </div>
                    </div>

                    <!-- Right: Existing Questions List -->
                    <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; height: fit-content;">
                        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px;">
                            <h3 style="color: white;">Current Questions</h3>
                            <button onclick="fetchQuestions()" style="background:none; border:none; color:var(--primary-glow); cursor:pointer;"><i class="ri-refresh-line"></i></button>
                        </div>
                        <div id="existingQuestionsList" style="width: 100%; max-height: 500px; overflow-y: auto;">
                            <!-- Questions loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: REPORTS -->
            <div id="tab-reports" class="hidden">
                <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px;">
                        <h3 style="color: white;">Submission History</h3>
                        <button onclick="fetchReports()" class="glow-button" style="width: auto; padding: 8px 20px;">Refresh Data</button>
                    </div>
                    
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User Email</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody">
                            <!-- Reports loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- DETAIL MODAL (Kept same) -->
    <div id="detailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center;">
        <div style="background:#1a1a1a; width:600px; padding:30px; border-radius:20px; position:relative; max-height:80vh; overflow-y:auto;">
            <i class="ri-close-line" onclick="document.getElementById('detailModal').style.display='none'" style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px; color:white;"></i>
            <h2 style="color:white;">Details</h2>
            <div id="modalBody" style="margin-top:20px;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sadprddxjtqscsourwub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZHByZGR4anRxc2Nzb3Vyd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjYyNTgsImV4cCI6MjA4MDAwMjI1OH0.-WHvQpXjwPTxaB_tbRDoBNcz80cWeORAnCl3QLDzuW0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- INIT ---
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            document.getElementById('adminEmail').innerText = session.user.email;
            
            addOptionInput();
            fetchQuestions();
            fetchReports();
        }
        init();

        function handleLogout() {
            supabase.auth.signOut().then(() => window.location.href = 'index.html');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-questions').classList.add('hidden');
            document.getElementById('tab-reports').classList.add('hidden');
            
            if(tabName === 'questions') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-questions').classList.remove('hidden');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-reports').classList.remove('hidden');
            }
        }

        // --- QUESTION LOGIC (Add/Edit/Delete) ---
        function addOptionInput(val = '', isFail = false) {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '10px'; div.style.marginBottom = '10px';
            div.innerHTML = `
                <input type="text" class="opt-text" value="${val}" placeholder="Option Text" style="margin:0;">
                <label style="display:flex; align-items:center; color:#aaa; white-space:nowrap; font-size:0.8rem;">
                    <input type="checkbox" class="opt-fail" ${isFail ? 'checked' : ''} style="width:auto; margin-right:5px;"> Fail?
                </label>
            `;
            document.getElementById('optionsList').appendChild(div);
        }

        async function saveQuestion() {
            const id = document.getElementById('editQId').value;
            const text = document.getElementById('qText').value;
            const type = document.getElementById('qType').value;
            let options = [];

            if(type !== 'data') {
                document.querySelectorAll('#optionsList div').forEach(row => {
                    const txt = row.querySelector('.opt-text').value;
                    const fail = row.querySelector('.opt-fail').checked;
                    if(txt) options.push({ text: txt, isFailResponse: fail });
                });
            }
            // For simple boolean questions (Single Choice), we might just use options array too
            // Note: The code assumes 'options' column stores JSON array of options

            if(!text) return alert("Text required");

            let error;
            if(id) {
                // UPDATE
                ({ error } = await supabase.from('questions').update({ text, type, options }).eq('id', id));
            } else {
                // INSERT
                ({ error } = await supabase.from('questions').insert([{ text, type, options }]));
            }

            if(error) alert(error.message);
            else {
                resetForm();
                fetchQuestions();
            }
        }

        function resetForm() {
            document.getElementById('editQId').value = '';
            document.getElementById('qText').value = '';
            document.getElementById('optionsList').innerHTML = '';
            addOptionInput();
            document.getElementById('formTitle').innerText = "Add New Question";
            document.getElementById('saveBtn').innerText = "Save Question";
            document.getElementById('cancelBtn').style.display = 'none';
        }

        async function editQuestion(id, text, type, optionsJson) {
            document.getElementById('editQId').value = id;
            document.getElementById('qText').value = text;
            document.getElementById('qType').value = type;
            document.getElementById('optionsList').innerHTML = '';
            
            // Rebuild options
            if(optionsJson && Array.isArray(optionsJson)) {
                optionsJson.forEach(opt => {
                    if(typeof opt === 'object') addOptionInput(opt.text, opt.isFailResponse);
                    else addOptionInput(opt, false); // Handle legacy simple string array
                });
            } else {
                addOptionInput();
            }

            document.getElementById('formTitle').innerText = "Edit Question #" + id;
            document.getElementById('saveBtn').innerText = "Update Question";
            document.getElementById('cancelBtn').style.display = 'inline-block';
        }

        async function deleteQuestion(id) {
            if(!confirm("Delete this question?")) return;
            await supabase.from('questions').delete().eq('id', id);
            fetchQuestions();
        }

        async function fetchQuestions() {
            const { data } = await supabase.from('questions').select('*').order('id', {ascending: true});
            const list = document.getElementById('existingQuestionsList');
            list.innerHTML = '';

            if(data) {
                data.forEach(q => {
                    // Properly escape strings for the onclick function
                    const safeText = q.text.replace(/'/g, "&apos;");
                    const safeOpts = JSON.stringify(q.options || []).replace(/"/g, "&quot;");
                    
                    list.innerHTML += `
                        <div class="q-item">
                            <div>
                                <div style="color:white; font-weight:500;">${q.text}</div>
                                <div style="color:#aaa; font-size:0.8rem;">Type: ${q.type}</div>
                            </div>
                            <div>
                                <button class="action-btn btn-edit" onclick='editQuestion(${q.id}, "${safeText}", "${q.type}", ${safeOpts})'><i class="ri-pencil-line"></i></button>
                                <button class="action-btn btn-del" onclick="deleteQuestion(${q.id})"><i class="ri-delete-bin-line"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- REPORTS LOGIC ---
        async function fetchReports() {
            const { data } = await supabase.from('submissions').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('reportsBody');
            tbody.innerHTML = '';
            if(data) {
                data.forEach(sub => {
                    const badgeClass = sub.status === 'Pass' ? 'badge-pass' : 'badge-fail';
                    const subData = encodeURIComponent(JSON.stringify(sub));
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(sub.created_at).toLocaleDateString()}</td>
                            <td>${sub.user_email}</td>
                            <td><span class="badge ${badgeClass}">${sub.status}</span></td>
                            <td>
                                <button class="action-btn" style="background:#444;" onclick="openModal('${subData}')">View</button>
                                <button class="action-btn btn-del" onclick="deleteReport(${sub.id})"><i class="ri-delete-bin-line"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        async function deleteReport(id) {
            if(!confirm("Are you sure you want to delete this report? This cannot be undone.")) return;
            const { error } = await supabase.from('submissions').delete().eq('id', id);
            if(error) alert(error.message);
            else fetchReports();
        }

        function openModal(encodedData) {
            const sub = JSON.parse(decodeURIComponent(encodedData));
            const body = document.getElementById('modalBody');
            body.innerHTML = '';
            
            if(sub.details && Array.isArray(sub.details)) {
                sub.details.forEach(d => {
                    body.innerHTML += `
                        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:10px;">
                            <div style="color:#aaa; font-size:0.8rem;">${d.question}</div>
                            <div style="color:white; font-weight:bold;">Answer: ${d.user_ans}</div>
                            ${d.comment ? `<div style="font-size:0.8rem; color:yellow; margin-top:5px;">Comment: ${d.comment}</div>` : ''}
                        </div>`;
                });
            } else {
                body.innerHTML = '<p style="color:white">No detailed answers available.</p>';
            }
            document.getElementById('detailModal').style.display = 'flex';
        }
    </script>
</body>
</html>