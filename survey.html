<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Survey | Covid Protocol</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Animated Background -->
    <div class="aurora-bg">
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Sticky Header with User Info & Timer -->
    <div class="sticky-header">
        <div class="timer-box">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="ri-user-heart-line" style="color:var(--secondary-glow); font-size:1.2rem;"></i>
                <div>
                    <span id="userNameDisplay" style="font-weight:600; display:block; line-height:1;">Worker</span>
                    <small style="color:var(--text-muted); font-size:0.8rem;">Covid Assessment</small>
                </div>
            </div>
            <div style="text-align:right;">
                <span style="font-size:0.8rem; color:var(--text-muted); display:block;">Time Remaining</span>
                <span id="timerDisplay" class="time-left">10</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" style="max-width: 800px; padding-top: 10px;">
        
        <form id="surveyForm">
            <!-- Questions inject here -->
            <div id="questionsWrapper"></div>

            <div style="margin-top: 40px; text-align: center; padding-bottom: 50px;">
                <button type="submit" class="glow-button" style="max-width: 300px; margin: 0 auto;">
                    <span>Submit Assessment</span>
                    <i class="ri-send-plane-fill"></i>
                </button>
            </div>
        </form>

    </div>

    <!-- Result Modal / Fullscreen Overlay -->
    <div id="resultOverlay" style="display:none; position:fixed; inset:0; z-index:200; background:rgba(3,3,5,0.95); backdrop-filter:blur(20px); align-items:center; justify-content:center;">
        <div class="glass-card" style="text-align:center; max-width:400px; animation: fadeInUp 0.5s ease;">
            <div id="resIcon" style="font-size:4rem; margin-bottom:10px;"></div>
            <h1 id="resStatus" style="font-size:3rem; margin-bottom:5px; font-weight:700;"></h1>
            <p id="resScore" style="color:var(--text-muted); font-size:1.2rem; margin-bottom:30px;"></p>
            <button onclick="location.href='index.html'" class="glow-button">Back to Home</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const SUPABASE_URL = 'https://sadprddxjtqscsourwub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZHByZGR4anRxc2Nzb3Vyd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjYyNTgsImV4cCI6MjA4MDAwMjI1OH0.-WHvQpXjwPTxaB_tbRDoBNcz80cWeORAnCl3QLDzuW0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let questionsData = [];
        let timeLeft = 600; // 10 minutes

        // --- 2. AUTH CHECK ---
        const user = JSON.parse(localStorage.getItem('surveyUser'));
        if(!user) window.location.href = 'index.html';
        document.getElementById('userNameDisplay').innerText = user.name;

        // --- 3. TIMER LOGIC ---
        const timerInterval = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            const text = `${m}:${s < 10 ? '0'+s : s}`;
            
            const timerEl = document.getElementById('timerDisplay');
            timerEl.innerText = text;
            
            // Red color warning on last minute
            if(timeLeft < 60) timerEl.style.color = 'var(--danger)';

            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                submitSurvey();
            }
        }, 1000);

        // --- 4. LOAD SURVEY ---
        async function loadSurvey() {
            const { data } = await supabase.from('questions').select('*').order('id', {ascending: true});
            questionsData = data || [];
            const wrapper = document.getElementById('questionsWrapper');

            if(questionsData.length === 0) {
                wrapper.innerHTML = `<div class="q-card" style="text-align:center;"><h3>No questions found.</h3></div>`;
                return;
            }

            questionsData.forEach((q, index) => {
                let optionsHtml = '';

                // Generate Options Logic
                if(q.type === 'data') {
                    optionsHtml = `<div style="padding:15px; background:rgba(59, 130, 246, 0.1); border-left:4px solid #3b82f6; border-radius:4px; color:#93c5fd;">
                        <i class="ri-information-line"></i> This is an informational slide. No answer required.
                    </div>`;
                } else if (q.options) {
                    optionsHtml = `<div class="options-grid">`;
                    q.options.forEach((opt, i) => {
                        // Unique ID for label connection
                        const uniqueId = `q${q.id}_opt${i}`;
                        
                        optionsHtml += `
                            <label class="option-label" for="${uniqueId}">
                                <input type="radio" id="${uniqueId}" name="q_${q.id}" value="${opt}">
                                <div class="option-tile">
                                    <span>${opt}</span>
                                </div>
                            </label>
                        `;
                    });
                    optionsHtml += `</div>`;
                }

                // Append Question Card
                wrapper.innerHTML += `
                    <div class="q-card">
                        <span class="q-number">Question ${index + 1}</span>
                        <div class="q-text">${q.text}</div>
                        ${optionsHtml}
                        <input type="text" class="comment-box" name="comment_${q.id}" placeholder="Type any comments here...">
                    </div>
                `;
            });
        }

        // --- 5. SUBMIT LOGIC ---
        document.getElementById('surveyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if(confirm("Are you sure you want to submit?")) {
                submitSurvey();
            }
        });

        async function submitSurvey() {
            clearInterval(timerInterval);
            
            // Show loading state
            const btn = document.querySelector('button[type="submit"]');
            btn.innerHTML = 'Calculating...';
            btn.disabled = true;

            const formData = new FormData(document.getElementById('surveyForm'));
            let score = 0;
            let totalScorable = 0;
            let details = [];

            questionsData.forEach(q => {
                if(q.type === 'data') return;
                
                totalScorable++;
                const answer = formData.get(`q_${q.id}`); // Returns value or null
                const comment = formData.get(`comment_${q.id}`);
                
                const isCorrect = (answer === q.correct_answer);
                if(isCorrect) score++;

                details.push({
                    question: q.text,
                    user_ans: answer || "Skipped",
                    correct: isCorrect,
                    comment: comment
                });
            });

            // Pass/Fail Logic (50%)
            const status = (score >= totalScorable / 2) ? "Pass" : "Fail";

            // Save to DB
            await supabase.from('submissions').insert({
                user_name: user.name,
                user_email: user.email,
                score: score,
                total_questions: totalScorable,
                status: status,
                details: details
            });

            // Show Result Screen
            const overlay = document.getElementById('resultOverlay');
            const resStatus = document.getElementById('resStatus');
            const resIcon = document.getElementById('resIcon');
            
            overlay.style.display = 'flex';
            
            if(status === 'Pass') {
                resStatus.innerText = 'PASSED';
                resStatus.style.color = 'var(--success)';
                resIcon.innerHTML = '<i class="ri-checkbox-circle-fill" style="color:var(--success)"></i>';
            } else {
                resStatus.innerText = 'FAILED';
                resStatus.style.color = 'var(--danger)';
                resIcon.innerHTML = '<i class="ri-close-circle-fill" style="color:var(--danger)"></i>';
            }
            
            document.getElementById('resScore').innerText = `You answered ${score} out of ${totalScorable} correctly.`;
        }

        // Init
        loadSurvey();
    </script>
</body>
</html>