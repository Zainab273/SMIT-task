<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | CovidSafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Admin Specific Styles */
        body { overflow-y: auto; }
        .content { padding: 40px 5%; max-width: 1200px; margin: 0 auto; }
        
        /* Tabs */
        .admin-tabs { display: flex; gap: 20px; margin-bottom: 20px; }
        .tab-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #aaa; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 600;
            transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary-glow); color: white; border-color: var(--primary-glow); }

        /* Tables */
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th { text-align: left; color: var(--text-muted); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: white; }
        .admin-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges */
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        .badge-pass { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-fail { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Modal for Details */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #1a1a1a; border: 1px solid #333; width: 600px; max-height: 80vh;
            overflow-y: auto; padding: 30px; border-radius: 20px; position: relative;
        }
        .close-modal { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #aaa; font-size: 24px; }

        /* Question List Item */
        .q-item {
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-del { color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 8px; border-radius: 8px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="aurora-bg"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <!-- Header -->
    <header style="position: sticky; top: 0; z-index: 50; padding: 20px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(3, 3, 5, 0.9); border-bottom: 1px solid rgba(255,255,255,0.08);">
        <div style="font-size: 22px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 10px;">
            <i class="ri-admin-line" style="color: var(--primary-glow);"></i> Admin Portal
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="adminEmail" style="color: #aaa; font-size: 0.9rem;"></span>
            <button onclick="handleLogout()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Logout</button>
        </div>
    </header>

    <div class="content">
        <div id="loadingState"><h2 style="color:white;">Verifying Admin Access...</h2></div>

        <!-- ADMIN CONTAINER -->
        <div id="adminContainer" class="hidden">
            
            <!-- Tabs Navigation -->
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('questions')">Manage Questions</button>
                <button class="tab-btn" onclick="switchTab('reports')">View Reports</button>
            </div>

            <!-- TAB 1: MANAGE QUESTIONS -->
            <div id="tab-questions">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    
                    <!-- Left: Add Form -->
                    <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; height: fit-content;">
                        <h3 style="color: white; margin-bottom: 20px;">Add New Question</h3>
                        
                        <input type="text" id="qText" placeholder="Enter Question Text here...">
                        
                        <select id="qType" style="background: #222; color: white; margin-bottom: 20px;">
                            <option value="single">Single Choice (Yes/No)</option>
                            <option value="multiple">Multiple Choice</option>
                            <option value="data">Info / Text Only</option>
                        </select>

                        <div id="optionsArea" style="width: 100%; margin-bottom: 15px;">
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 10px;">Answer Options:</p>
                            <div id="optionsList"></div>
                            <button onclick="addOptionInput()" style="background: none; border: 1px dashed #555; color: #aaa; padding: 8px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 5px;">+ Add Option</button>
                        </div>

                        <button onclick="saveQuestion()" class="glow-button">Save to Database</button>
                    </div>

                    <!-- Right: Existing Questions List -->
                    <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; height: fit-content;">
                        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px;">
                            <h3 style="color: white;">Current Questions</h3>
                            <button onclick="fetchQuestions()" style="background:none; border:none; color:var(--primary-glow); cursor:pointer;"><i class="ri-refresh-line"></i></button>
                        </div>
                        <div id="existingQuestionsList" style="width: 100%; max-height: 500px; overflow-y: auto;">
                            <!-- Questions loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: REPORTS -->
            <div id="tab-reports" class="hidden">
                <div class="glass-card" style="flex-direction: column; align-items: flex-start; padding: 30px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px;">
                        <h3 style="color: white;">Submission History</h3>
                        <button onclick="fetchReports()" class="glow-button" style="width: auto; padding: 8px 20px;">Refresh Data</button>
                    </div>
                    
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User Email</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="reportsBody">
                            <!-- Reports loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- REPORT DETAIL MODAL -->
    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <i class="ri-close-line close-modal" onclick="closeModal()"></i>
            <h2 style="color: white; margin-bottom: 5px;">Submission Details</h2>
            <p id="modalUser" style="color: var(--primary-glow); margin-bottom: 20px;"></p>
            
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://sadprddxjtqscsourwub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZHByZGR4anRxc2Nzb3Vyd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjYyNTgsImV4cCI6MjA4MDAwMjI1OH0.-WHvQpXjwPTxaB_tbRDoBNcz80cWeORAnCl3QLDzuW0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // *** ADMIN EMAIL ***
        const ADMIN_EMAIL = 'admin123@gmail.com'; 

        // --- INIT ---
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            
            // Check if Admin
            if (session.user.email !== ADMIN_EMAIL) {
                alert("Access Denied. Admins only.");
                window.location.href = 'index.html'; // Or user dashboard
                return;
            }

            document.getElementById('adminEmail').innerText = session.user.email;
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('adminContainer').classList.remove('hidden');
            
            // Load Initial Data
            addOptionInput();
            fetchQuestions();
            fetchReports();
        }
        init();

        function handleLogout() {
            supabase.auth.signOut().then(() => window.location.href = 'index.html');
        }

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#adminContainer > div[id^="tab-"]').forEach(d => d.classList.add('hidden'));
            
            if(tabName === 'questions') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-questions').classList.remove('hidden');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-reports').classList.remove('hidden');
            }
        }

        // --- QUESTIONS LOGIC ---
        function addOptionInput() {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '10px'; div.style.marginBottom = '10px';
            div.innerHTML = `
                <input type="text" class="opt-text" placeholder="Option Text" style="margin:0;">
                <label style="display:flex; align-items:center; color:#aaa; white-space:nowrap; font-size:0.8rem;">
                    <input type="checkbox" class="opt-fail" style="width:auto; margin-right:5px;"> Fail Trigger?
                </label>
            `;
            document.getElementById('optionsList').appendChild(div);
        }

        async function saveQuestion() {
            const text = document.getElementById('qText').value;
            const type = document.getElementById('qType').value;
            let options = [];

            if(type !== 'data') {
                document.querySelectorAll('#optionsList div').forEach(row => {
                    const txt = row.querySelector('.opt-text').value;
                    const fail = row.querySelector('.opt-fail').checked;
                    if(txt) options.push({ text: txt, isFailResponse: fail });
                });
            }

            if(!text) return alert("Question text is required");

            const { error } = await supabase.from('questions').insert([{ text, type, options }]);
            if(error) alert(error.message);
            else {
                alert("Question Added!");
                document.getElementById('qText').value = '';
                document.getElementById('optionsList').innerHTML = '';
                addOptionInput();
                fetchQuestions(); // Refresh list
            }
        }

        async function fetchQuestions() {
            const { data, error } = await supabase.from('questions').select('*').order('id', {ascending: true});
            const list = document.getElementById('existingQuestionsList');
            list.innerHTML = '';

            if(data) {
                data.forEach(q => {
                    list.innerHTML += `
                        <div class="q-item">
                            <div>
                                <div style="color:white; font-weight:500;">${q.text}</div>
                                <div style="color:#aaa; font-size:0.8rem;">Type: ${q.type}</div>
                            </div>
                            <button class="btn-del" onclick="deleteQuestion(${q.id})"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    `;
                });
            }
        }

        async function deleteQuestion(id) {
            if(!confirm("Are you sure you want to delete this question?")) return;
            await supabase.from('questions').delete().eq('id', id);
            fetchQuestions();
        }

        // --- REPORTS LOGIC ---
        async function fetchReports() {
            const { data, error } = await supabase.from('submissions').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('reportsBody');
            tbody.innerHTML = '';

            if(data) {
                data.forEach(sub => {
                    const badgeClass = sub.result === 'Pass' ? 'badge-pass' : 'badge-fail';
                    // Store data in button attribute to pass to modal
                    const subData = encodeURIComponent(JSON.stringify(sub));
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(sub.created_at).toLocaleString()}</td>
                            <td>${sub.email}</td>
                            <td><span class="badge ${badgeClass}">${sub.result}</span></td>
                            <td>
                                <button onclick="openModal('${subData}')" style="background:rgba(255,255,255,0.1); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
        }

        // --- MODAL LOGIC ---
        function openModal(encodedData) {
            const sub = JSON.parse(decodeURIComponent(encodedData));
            document.getElementById('modalUser').innerText = `User: ${sub.email} | Result: ${sub.result}`;
            
            const body = document.getElementById('modalBody');
            body.innerHTML = '';

            // Loop through answers (Note: We need question text. 
            // Ideally, we fetch questions again or store text in submission. 
            // For now, we show the Question ID or try to match if possible. 
            // To keep it simple, we will display the Answer Data).
            
            if(sub.answers) {
                for (const [qId, ansData] of Object.entries(sub.answers)) {
                    const comment = sub.comments && sub.comments[qId] ? sub.comments[qId] : "No comment";
                    const isFail = ansData.isFail ? '<span style="color:#ef4444">(Fail Trigger)</span>' : '';
                    
                    body.innerHTML += `
                        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:10px;">
                            <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">Question ID: ${qId}</div>
                            <div style="color:white; font-weight:bold;">Answer: ${ansData.selected.join(', ')} ${isFail}</div>
                            <div style="color:#aaa; font-size:0.9rem; margin-top:5px;"><i>Comment: ${comment}</i></div>
                        </div>
                    `;
                }
            } else {
                body.innerHTML = '<p style="color:white;">No answer data found.</p>';
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if(e.target.id === 'detailModal') closeModal();
        });

    </script>
</body>
</html>