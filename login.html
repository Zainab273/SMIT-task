<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | CovidSafe</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .link-text { color: #8b5cf6; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }
        
        /* Role Badge */
        .role-badge {
            display: inline-block; padding: 5px 15px; border-radius: 20px;
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 15px; font-weight: 700;
        }
        .role-admin { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .role-worker { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3); }

        /* --- CUSTOM TOAST (Popup Alert) --- */
        #loginToast {
            position: fixed; top: 20px; right: 20px;
            background: rgba(20, 20, 20, 0.95);
            color: white; padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 2000; display: flex; align-items: center; gap: 12px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            min-width: 300px;
        }
        #loginToast.show { transform: translateX(0); }
        
        /* Variants */
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-success { border-left: 4px solid #10b981; }
        
        .toast-icon { font-size: 1.3rem; }
        .ri-error-warning-fill { color: #ef4444; }
        .ri-checkbox-circle-fill { color: #10b981; }
    </style>
</head>
<body>
    <div class="aurora-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <!-- CUSTOM NOTIFICATION (Hidden initially) -->
    <div id="loginToast">
        <i id="toastIcon" class="toast-icon"></i>
        <div>
            <strong id="toastTitle" style="display:block; font-size:0.9rem;">Title</strong>
            <span id="toastMsg" style="font-size:0.85rem; color:#ccc;">Message goes here</span>
        </div>
    </div>

    <div class="center-screen">
        <div class="glass-card" style="width: 400px;">
            
            <div style="text-align: center; margin-bottom: 25px;">
                <!-- Role Badge -->
                <div id="roleBadge" class="role-badge"></div>
                
                <h2 id="pageTitle">Welcome</h2>
                <p id="pageDesc" style="color: var(--text-muted);">Please sign in</p>
            </div>

            <!-- Form -->
            <form id="authForm">
                <input type="text" id="inputName" placeholder="Full Name" style="display:none;">
                <input type="email" id="inputEmail" placeholder="Email Address" required>
                <input type="password" id="inputPassword" placeholder="Password" required>
                
                <button type="submit" id="submitBtn" class="glow-button">Login</button>
            </form>
            
            <!-- Create Account Toggle (Hidden for Admin) -->
            <div id="workerToggle" style="text-align: center; margin-top: 15px; display:none;">
                <p style="color:#aaa;">New here? <span class="link-text" onclick="toggleSignupMode()">Create Account</span></p>
            </div>

            <p style="text-align:center; margin-top:20px; font-size:0.9rem;">
                <a href="index.html" style="color:var(--text-muted); text-decoration:none;">&larr; Switch Role</a>
            </p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sadprddxjtqscsourwub.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhZHByZGR4anRxc2Nzb3Vyd3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjYyNTgsImV4cCI6MjA4MDAwMjI1OH0.-WHvQpXjwPTxaB_tbRDoBNcz80cWeORAnCl3QLDzuW0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==========================================
        // ðŸ”’ ADMIN EMAIL CONFIG
        const ADMIN_EMAIL = 'admin123@gmail.com';
        // ==========================================

        const urlParams = new URLSearchParams(window.location.search);
        const CURRENT_ROLE = urlParams.get('role') === 'admin' ? 'admin' : 'worker';

        const title = document.getElementById('pageTitle');
        const roleBadge = document.getElementById('roleBadge');
        const nameInput = document.getElementById('inputName');
        const submitBtn = document.getElementById('submitBtn');
        const workerToggle = document.getElementById('workerToggle');
        
        let isSignup = false;

        // --- UI HELPER: SHOW TOAST ---
        function showToast(title, msg, type = 'error') {
            const toast = document.getElementById('loginToast');
            const icon = document.getElementById('toastIcon');
            const titleEl = document.getElementById('toastTitle');
            const msgEl = document.getElementById('toastMsg');

            // Reset classes
            toast.classList.remove('toast-error', 'toast-success');
            
            if (type === 'error') {
                toast.classList.add('toast-error');
                icon.className = 'ri-error-warning-fill toast-icon';
                icon.style.color = '#ef4444';
            } else {
                toast.classList.add('toast-success');
                icon.className = 'ri-checkbox-circle-fill toast-icon';
                icon.style.color = '#10b981';
            }

            titleEl.innerText = title;
            msgEl.innerText = msg;

            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }

        // --- 1. SETUP PAGE UI ---
        function initPage() {
            if (CURRENT_ROLE === 'admin') {
                roleBadge.innerText = "Admin Portal";
                roleBadge.classList.add('role-admin');
                title.innerText = "Admin Login";
                workerToggle.style.display = 'none';
                submitBtn.innerText = "Access Dashboard";
            } else {
                roleBadge.innerText = "Worker Portal";
                roleBadge.classList.add('role-worker');
                title.innerText = "Worker Login";
                workerToggle.style.display = 'block';
                submitBtn.innerText = "Login";
            }
        }
        initPage();

        // --- 2. TOGGLE SIGNUP ---
        function toggleSignupMode() {
            isSignup = !isSignup;
            if(isSignup) {
                title.innerText = "Create Account";
                submitBtn.innerText = "Sign Up";
                nameInput.style.display = "block";
                nameInput.required = true;
                workerToggle.innerHTML = `<p style="color:#aaa;">Have an account? <span class="link-text" onclick="toggleSignupMode()">Login</span></p>`;
            } else {
                title.innerText = "Worker Login";
                submitBtn.innerText = "Login";
                nameInput.style.display = "none";
                nameInput.required = false;
                workerToggle.innerHTML = `<p style="color:#aaa;">New here? <span class="link-text" onclick="toggleSignupMode()">Create Account</span></p>`;
            }
        }

        // --- 3. SUBMIT HANDLER ---
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('inputEmail').value.trim().toLowerCase();
            const password = document.getElementById('inputPassword').value;
            const name = document.getElementById('inputName').value;

            // ðŸ›‘ STRICT ROLE CHECK
            if (CURRENT_ROLE === 'admin') {
                if (email !== ADMIN_EMAIL.toLowerCase()) {
                    showToast("Access Denied", "This email is not authorized for Admin.", "error");
                    return;
                }
            } else {
                if (email === ADMIN_EMAIL.toLowerCase()) {
                    showToast("Wrong Portal", "This is an Admin ID. Switch role to login.", "error");
                    return;
                }
            }

            // Proceed
            const originalBtnText = submitBtn.innerText;
            submitBtn.innerText = "Processing...";
            submitBtn.disabled = true;

            try {
                if(isSignup && CURRENT_ROLE === 'worker') {
                    // Sign Up
                    const { data, error } = await supabase.auth.signUp({
                        email: email, password: password, options: { data: { full_name: name } }
                    });
                    if (error) throw error;
                    
                    showToast("Success", "Account created! You can now login.", "success");
                    toggleSignupMode();
                    submitBtn.innerText = "Login";
                } else {
                    // Login
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;

                    // Final Redirect
                    if (CURRENT_ROLE === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'survey.html';
                    }
                }
            } catch (err) {
                showToast("Login Failed", err.message, "error");
                submitBtn.innerText = originalBtnText;
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>